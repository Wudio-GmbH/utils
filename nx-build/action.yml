name: 'NX Build'
description: 'Build all Nx projects and upload artifacts'

inputs:
  node-version:
    description: 'Node.js version'
    required: false
    default: '23.x'
  command:
    description: 'Nx build command to run (default: build all)'
    required: false
    default: 'nx run-many --target=build --all --verbose'
  location:
    description: 'Location of the NX Workspace'
    required: false
    default: ''
  artifact:
    description: 'Name of the artifact'
    type: string
    required: true

outputs:
  build-cache:
    description: 'Whether the build cache was hit'

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v5

    - uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Prepare environment
      shell: bash
      working-directory: ${{ inputs.location }}
      run: |
        rm -f workspace/environments/src/lib/environments.ts
        mv workspace/environments/src/lib/environments.run.ts workspace/environments/src/lib/environments.ts

    - name: Cache node_modules
      id: cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ${{ inputs.location }}workspace/node_modules
        key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}

    - name: Install dependencies & Build all Nx projects
      shell: bash
      working-directory: ${{ inputs.location }}
      run: |
        cd workspace
        npm install -g nx
        npm ci
        ${{ inputs.command }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact }}
        path: |
          ${{ inputs.location }}workspace/dist/
          ${{ inputs.location }}workspace/node_modules/
          !${{ inputs.location }}workspace/dist/**/*.map
        retention-days: 1

    - name: Export cache hit result
      shell: bash
      run: echo "build-cache=${{ steps.cache.outputs.cache-hit }}" >> $GITHUB_OUTPUT
