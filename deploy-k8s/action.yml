name: "Deploy to Kubernetes"
description: "Applies Kubernetes manifests for a given service using a kubeconfig secret."

inputs:
  kubeconfig:
    description: "Base64 encoded kubeconfig"
    required: true
  service:
    description: "Service name (e.g., backend)"
    required: true
  image:
    description: "Full image reference (e.g., ghcr.io/org/app:sha-...)"
    required: true
  commitHash:
    description: "Commit Hash for the deployment Tag"
    required: true
  namespace:
    description: "Kubernetes namespace"
    required: false
    default: "wudio"

runs:
  using: "composite"
  steps:

    # 1ï¸âƒ£ Write kubeconfig
    - name: Set up kubeconfig
      shell: bash
      run: |
        echo "${{ inputs.kubeconfig }}" > kubeconfig.yaml
        mkdir -p ~/.kube
        cp kubeconfig.yaml ~/.kube/config
        chmod 600 ~/.kube/config
        echo "âœ… Kubeconfig setup complete"
    
    # 2ï¸âƒ£ Verify cluster connection
    - name: Verify connection
      shell: bash
      run: kubectl get nodes

    - name: Create namespace if not exists
      shell: bash
      run: |
        if kubectl get namespace ${{ inputs.namespace }} >/dev/null 2>&1; then
          echo "âœ… Namespace '${{ inputs.namespace }}' already exists."
        else
          echo "ğŸš€ Creating namespace '${{ inputs.namespace }}'..."
          kubectl create namespace ${{ inputs.namespace }}
        fi


    # 3ï¸âƒ£ Apply deployment + service
    - name: Apply manifests
      shell: bash
      env:
        IMAGE_TAG: ${{ inputs.commitHash }}
      run: |

        echo "ğŸ§ª DEBUG â€” Deploy Step Variables"
        echo "â€¢ inputs.image: '${{ inputs.image }}'"
        echo "â€¢ IMAGE_TAG: '${IMAGE_TAG}'"
        echo "â€¢ combined: '${{ inputs.image }}:${IMAGE_TAG}'"

        # PrÃ¼fe, ob image leer ist
        if [ -z "${{ inputs.image }}" ]; then
          echo "âŒ ERROR: inputs.image ist leer!"
        else
          echo "âœ” inputs.image ist gesetzt"
        fi

        # PrÃ¼fe IMAGE_TAG
        if [ -z "${IMAGE_TAG}" ]; then
          echo "âŒ ERROR: IMAGE_TAG ist leer!"
        else
          echo "âœ” IMAGE_TAG ist gesetzt"
        fi

        # Jetzt final zusammensetzen
        IMAGE="${{ inputs.image }}:${IMAGE_TAG}"
        echo "ğŸ”„ Deploying service ${{ inputs.service }} with image $IMAGE"

        # Versuche zuerst, das Image im bestehenden Deployment zu setzen
        if ! kubectl set image deployment/${{ inputs.service }} \
          ${{ inputs.service }}=$IMAGE -n ${{ inputs.namespace }} --record; then
          echo "â„¹ï¸ Deployment not found, creating new one..."
          # Ersetze den Platzhalter im YAML on the fly
          envsubst < deployments/deployment.${{ inputs.service }}.yml | kubectl apply -f -
        fi